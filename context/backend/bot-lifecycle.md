# Bot Service Lifecycle & Runbook

Use this guide when diagnosing bot availability, queue saturation, or Redis
state drift. The bot service is now modularized across multiple files in
`backend/bots/`.

## Architecture

The bot service is now split into focused modules:

- **`index.js`** - Main entry point, orchestrates modules (~200 lines)
- **`lib/config.js`** - Configuration and environment validation
- **`lib/leaderElection.js`** - Leadership election with proper error handling
- **`lib/matchmaking.js`** - Bot deployment, queue management, and rotation
- **`lib/apiClient.js`** - HTTP client for Colyseus API interactions
- **`lib/queueCleanup.js`** - Queue state cleanup utilities (existing)

## High-Level Flow

1. **Startup**
   - Validates environment variables via `config.validateEnv()`
   - Creates Redis client (cluster or single instance)
   - Loads Lua scripts including atomic `matchBot` script
   - Connects to MongoDB (`MONGODB_URI`) to load bot metadata
   - Sets up pub/sub listener on `bots:commands`
   - Starts leadership election loop
2. **Leadership Election**
   - Uses atomic `SET NX` for leader acquisition
   - Only the leader instance deploys/recalls bots
   - Leadership renewed via custom `extendLeader` Lua script
   - Renewal every `BOT_LEADER_TTL_MS / 2` (default 7.5s)
   - **NEW**: Proper error handling with exponential backoff on failures
3. **Deployment Loop** (Leader only)
   - Reads config from `bots:rotation:config`
   - **NEW**: Uses atomic Redis operations to prevent race conditions
   - Deploys bots up to configured `maxDeployed`
   - Each deployment spawns a Colyseus client, authenticates with
     `BOT_SERVICE_SECRET`, and joins the queue after
     `BOT_INITIAL_JOIN_DELAY_MS`
   - **NEW**: Cycle guards prevent duplicate bot deployments across instances
4. **Queue Pruning** (Leader only)
   - Every `BOT_QUEUE_PRUNE_INTERVAL_MS` (default 30s)
   - Removes stale entries from bot tracking sets
   - Recycles orphaned bots back to rotation queue
5. **Command Handling**
   - Subscribes to `bots:commands` channel
   - Processes: `deploy`, `stop`, `botMatchComplete`, `rotateConfig`, `checkDeployment`
   - Only leader processes commands (others ignore)
6. **Auto-Deployment of New Bots**
   - When new bots are created via `/admin/bots/generate`, they are automatically added to `bots:rotation:queue`
   - A `checkDeployment` command is published to trigger immediate evaluation
   - If deployed bot count is below minimum, new bots are automatically deployed

## Redis Keys

**Note**: Deployment state is tracked **only** in Redis, not in MongoDB. The `bots:deployed` set is the single source of truth for which bots are currently deployed.

| Key | Purpose | Notes |
|-----|---------|-------|
| `bots:leader` | Leadership lease | Value = instance ID; TTL ~15s; atomic SET NX |
| `bots:deployed` | Bots currently deployed | Set; **single source of truth** for deployment |
| `bots:active` | Bots currently in match | Set; synced with match room lifecycle |
| `bots:cycling` | Bots with active deployment cycle | Set; prevents duplicate deployments |
| `bots:rotation:queue` | Round-robin queue of bot IDs | List; rebuilt on startup, new bots auto-added on creation |
| `bots:rotation:config` | Hash with `maxDeployed`, `totalBots`, `deployDelayMs` | Adjust to tune bot pressure |
| `bots:state:${botId}` | Bot lifecycle state | String: 'queued', 'matched', 'playing' |
| `bots:commands` | Pub/sub for bot commands | Channel for `deploy`, `stop`, `rotateConfig`, etc. |
| `queue:reservation:${botId}` | Active match reservation | JSON; checked atomically to avoid race conditions |
| `queue:elo` | Sorted set of users by ELO | Score = ELO rating; used for matchmaking |

## Atomic Operations

**NEW**: Critical operations now use Lua scripts for atomicity:

- **`matchBot.lua`**: Atomically dequeues a user from `queue:elo` and matches with a bot
- **`extendLeader`**: Atomically extends leadership TTL only if still leader
- **`$inc` for ELO updates**: MongoDB ratings now use `$inc` instead of read-modify-write

## Deployment Checklist

- [ ] Redis reachable (`redis-cli -h <host> -p <port> ping`)
- [ ] MongoDB reachable and collection `bots` populated
- [ ] `BOT_SERVICE_SECRET` matches Colyseus config
- [ ] `BOT_INSTANCE_ID` unique per pod/VM (auto-generated by default)
- [ ] `BOT_DEPLOY_DELAY_MS`, `BOT_INITIAL_JOIN_DELAY_MS` tuned for environment

## Troubleshooting

**Bots never deploy**
- Verify instance became leader (`logs` showing `✅ Acquired leadership`)
- Ensure `bots:rotation:config` exists; rebuild by running
  `POST /admin/bots/rebuild` if available (or restart service)
- Check MongoDB `bots` collection contains documents

**Bots stuck in queue**
- Inspect `bots:active` vs `bots:deployed`; remove stale entries:
  ```bash
  redis-cli srem bots:deployed <botId>
  redis-cli srem bots:active <botId>
  ```
- Run `node backend/bots/lib/queueCleanup.js` or the Jest test
  `backend/bots/__tests__/queueCleanup.test.js` for reference

**Leadership thrashing**
- Increase `BOT_LEADER_TTL_MS` and ensure clock skew is minimal
- Watch logs for `⚠️ Failed to extend leadership lease`

**Emergency bots missing**
- Confirm Colyseus published `playerQueued` commands; see
  `context/backend/matchmaking-flow.md`
- Check `bots:nudges` subscription logs

## Helpful Commands

```bash
# View leader
redis-cli get bots:leader

# Inspect rotation config
redis-cli hgetall bots:rotation:config

# List deployed bots
redis-cli smembers bots:deployed

# Clear bot queue state (use with caution)
node backend/bots/lib/queueCleanup.js --force
```

## Related Docs

- `context/backend/matchmaking-flow.md`
- `context/backend/judge0-runbook.md`
- `backend/bots/__tests__/queueCleanup.test.js`


