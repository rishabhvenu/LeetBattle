# Bot Service Lifecycle & Runbook

Use this guide when diagnosing bot availability, queue saturation, or Redis
state drift. It summarizes the Node.js bot service located at
`backend/bots/index.js`.

## High-Level Flow

1. **Startup**
   - Connects to Redis (`REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD`)
   - Connects to MongoDB (`MONGODB_URI`) to load bot metadata
   - Acquires leader lock (`bots:leader`) using Lua `extendLeader`
   - Rebuilds rotation queue and honours existing deployments
2. **Leadership**
   - Only the leader instance deploys/recalls bots
   - Leadership renewed via `extendLeader` every
     `BOT_LEADER_TTL_MS / 2` (default 7.5s)
3. **Deployment Loop**
   - Reads config from `bots:rotation:config`
   - Deploys bots up to configured `maxDeployed`
   - Each deployment spawns a Colyseus client, authenticates with
     `BOT_SERVICE_SECRET`, and joins the queue after
     `BOT_INITIAL_JOIN_DELAY_MS`
4. **Queue Pruning**
   - Every `BOT_QUEUE_PRUNE_INTERVAL_MS` (default 30s)
   - Removes stale entries from bot tracking sets
5. **Command Handling**
   - Subscribes to `bots:commands`
   - Handles `playerQueued`, `boostQueue`, and manual `deploy`/`recall`
     commands

## Redis Keys

| Key | Purpose | Notes |
|-----|---------|-------|
| `bots:leader` | Leadership lease | Value = instance ID; TTL ~15s |
| `bots:deployed` | Bots currently deployed | Updated on deploy/recall |
| `bots:active` | Bots currently in match | Synced with Colyseus callbacks |
| `bots:rotation:queue` | Round-robin queue of bot IDs | Rebuilt on startup |
| `bots:rotation:config` | Hash with `maxDeployed`, `totalBots` | Adjust to tune pressure |
| `bots:nudges` | Pub/sub for emergency nudges | Published by Colyseus when humans wait |
| `queue:reservation:${botId}` | Active match binding | Checked to avoid duplicate deployments |

## Deployment Checklist

- [ ] Redis reachable (`redis-cli -h <host> -p <port> ping`)
- [ ] MongoDB reachable and collection `bots` populated
- [ ] `BOT_SERVICE_SECRET` matches Colyseus config
- [ ] `BOT_INSTANCE_ID` unique per pod/VM (auto-generated by default)
- [ ] `BOT_DEPLOY_DELAY_MS`, `BOT_INITIAL_JOIN_DELAY_MS` tuned for environment

## Troubleshooting

**Bots never deploy**
- Verify instance became leader (`logs` showing `✅ Acquired leadership`)
- Ensure `bots:rotation:config` exists; rebuild by running
  `POST /admin/bots/rebuild` if available (or restart service)
- Check MongoDB `bots` collection contains documents

**Bots stuck in queue**
- Inspect `bots:active` vs `bots:deployed`; remove stale entries:
  ```bash
  redis-cli srem bots:deployed <botId>
  redis-cli srem bots:active <botId>
  ```
- Run `node backend/bots/lib/queueCleanup.js` or the Jest test
  `backend/bots/__tests__/queueCleanup.test.js` for reference

**Leadership thrashing**
- Increase `BOT_LEADER_TTL_MS` and ensure clock skew is minimal
- Watch logs for `⚠️ Failed to extend leadership lease`

**Emergency bots missing**
- Confirm Colyseus published `playerQueued` commands; see
  `context/backend/matchmaking-flow.md`
- Check `bots:nudges` subscription logs

## Helpful Commands

```bash
# View leader
redis-cli get bots:leader

# Inspect rotation config
redis-cli hgetall bots:rotation:config

# List deployed bots
redis-cli smembers bots:deployed

# Clear bot queue state (use with caution)
node backend/bots/lib/queueCleanup.js --force
```

## Related Docs

- `context/backend/matchmaking-flow.md`
- `context/backend/judge0-runbook.md`
- `backend/bots/__tests__/queueCleanup.test.js`


