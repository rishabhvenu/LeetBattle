#!/bin/bash
# Don't use set -e here as we want to handle errors explicitly

# Load config (languages.json, DB config variables, etc)
source ./scripts/load-config || {
  echo "Failed to load config" >&2
  exit 1
}

# Ensure no leftover PID files
rm -f tmp/pids/server.pid

# Rails database setup (safe on repeat)
bundle exec rails db:create    || true
bundle exec rails db:migrate   || true
bundle exec rails db:seed      || true

# Start Judge0 API server on correct port
# Use exec to replace shell process with Rails server
# Ensure we're in the right directory
cd /api || {
  echo "Failed to change to /api directory" >&2
  exit 1
}

# Verify bundle is available
if ! command -v bundle &> /dev/null; then
  echo "bundle command not found" >&2
  exit 1
fi

echo "Starting Rails server with: bundle exec rails server -b 0.0.0.0 -p 2358" >&2
echo "Bundle location: $(which bundle)" >&2
echo "Rails location: $(bundle exec which rails 2>/dev/null || echo 'not found')" >&2

# Test the command first
echo "Testing: bundle exec rails --version" >&2
bundle exec rails --version >&2 || echo "Failed to get Rails version" >&2

# Check if we're in a Rails app directory
if [ ! -f "Gemfile" ]; then
  echo "ERROR: Gemfile not found in current directory $(pwd)" >&2
  exit 1
fi

echo "Current directory: $(pwd)" >&2
echo "Gemfile exists: $([ -f Gemfile ] && echo 'yes' || echo 'no')" >&2

# Start Rails server - use exec to replace shell process
# Use explicit bundle exec with full command
echo "Executing Rails server..." >&2
echo "Command: bundle exec rails s -b 0.0.0.0 -p 2358" >&2

# Try running without exec first to see actual error
bundle exec rails s -b 0.0.0.0 -p 2358 &
RAILS_PID=$!
echo "Rails server started in background with PID: $RAILS_PID" >&2

# Wait for Rails process
wait $RAILS_PID
EXIT_CODE=$?
echo "Rails server exited with code: $EXIT_CODE" >&2
exit $EXIT_CODE
