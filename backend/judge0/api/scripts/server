#!/bin/bash
# Don't use set -e here as we want to handle errors explicitly

# Load config (languages.json, DB config variables, etc)
source ./scripts/load-config || {
  echo "Failed to load config" >&2
  exit 1
}

# Ensure no leftover PID files
rm -f tmp/pids/server.pid

# Rails database setup (safe on repeat)
bundle exec rails db:create    || true
bundle exec rails db:migrate   || true
bundle exec rails db:seed      || true

# Start Judge0 API server on correct port
# Use exec to replace shell process with Rails server
# Ensure we're in the right directory
cd /api || {
  echo "Failed to change to /api directory" >&2
  exit 1
}

# Verify bundle is available
if ! command -v bundle &> /dev/null; then
  echo "bundle command not found" >&2
  exit 1
fi

echo "Starting Rails server with: bundle exec rails server -b 0.0.0.0 -p 2358" >&2
echo "Bundle location: $(which bundle)" >&2
echo "Rails location: $(bundle exec which rails 2>/dev/null || echo 'not found')" >&2

# Test the command first
echo "Testing: bundle exec rails --version" >&2
bundle exec rails --version >&2 || echo "Failed to get Rails version" >&2

# Check if we're in a Rails app directory
if [ ! -f "Gemfile" ]; then
  echo "ERROR: Gemfile not found in current directory $(pwd)" >&2
  exit 1
fi

echo "Current directory: $(pwd)" >&2
echo "Gemfile exists: $([ -f Gemfile ] && echo 'yes' || echo 'no')" >&2

# Check Rails installation in bundle
echo "Checking Rails installation..." >&2
bundle show rails >&2 || echo "Rails not found in bundle" >&2

# Start Rails server - use exec to replace shell process
# Use full 'server' command instead of 's' shortcut
echo "Executing: exec bundle exec rails server -b 0.0.0.0 -p 2358" >&2

# Try using Puma directly instead of Rails server command
# This avoids the issue with Rails command parsing
echo "Attempting to start server with Puma directly..." >&2

# Set PORT environment variable for Puma config
export PORT=2358

# Check if puma is available
if bundle exec which puma >/dev/null 2>&1; then
  echo "Using: bundle exec puma -b tcp://0.0.0.0:2358" >&2
  exec bundle exec puma -b tcp://0.0.0.0:2358
elif bundle exec which rackup >/dev/null 2>&1; then
  echo "Using: bundle exec rackup -o 0.0.0.0 -p 2358" >&2
  exec bundle exec rackup -o 0.0.0.0 -p 2358
else
  # Fallback: try rails server with explicit array-style command
  echo "Fallback: Using bundle exec with explicit rails server command" >&2
  exec bundle exec sh -c 'rails server -b 0.0.0.0 -p 2358'
fi
