#!/bin/bash
# Don't use set -e here as we want to handle errors explicitly

# Load config (languages.json, DB config variables, etc)
source ./scripts/load-config || {
  echo "Failed to load config" >&2
  exit 1
}

# Ensure no leftover PID files
rm -f tmp/pids/server.pid

# Rails database setup (safe on repeat)
bundle exec rails db:create    || true
bundle exec rails db:migrate   || true
bundle exec rails db:seed      || true

# Start Judge0 API server on correct port
# Use exec to replace shell process with Rails server
# Ensure we're in the right directory
cd /api || {
  echo "Failed to change to /api directory" >&2
  exit 1
}

# Verify bundle is available
if ! command -v bundle &> /dev/null; then
  echo "bundle command not found" >&2
  exit 1
fi

echo "Starting Rails server with: bundle exec rails server -b 0.0.0.0 -p 2358" >&2
echo "Bundle location: $(which bundle)" >&2
echo "Rails location: $(bundle exec which rails 2>/dev/null || echo 'not found')" >&2

# Test the command first
echo "Testing: bundle exec rails --version" >&2
bundle exec rails --version >&2 || echo "Failed to get Rails version" >&2

# Check if we're in a Rails app directory
if [ ! -f "Gemfile" ]; then
  echo "ERROR: Gemfile not found in current directory $(pwd)" >&2
  exit 1
fi

echo "Current directory: $(pwd)" >&2
echo "Gemfile exists: $([ -f Gemfile ] && echo 'yes' || echo 'no')" >&2

# Check Rails installation in bundle
echo "Checking Rails installation..." >&2
bundle show rails >&2 || echo "Rails not found in bundle" >&2

# Start Rails server - use exec to replace shell process
# Use full 'server' command instead of 's' shortcut
echo "Executing: exec bundle exec rails server -b 0.0.0.0 -p 2358" >&2

# Find the actual Rails executable from bundle
BUNDLED_RAILS=$(bundle exec which rails 2>/dev/null)
if [ -z "$BUNDLED_RAILS" ] || [ "$BUNDLED_RAILS" = "/usr/local/bin/rails" ]; then
  # Try to find Rails in the bundle path
  BUNDLE_PATH=$(bundle show rails 2>/dev/null | head -1)
  if [ -n "$BUNDLE_PATH" ]; then
    BUNDLED_RAILS="$BUNDLE_PATH/bin/rails"
  fi
fi

echo "Using Rails executable: ${BUNDLED_RAILS:-bundle exec rails}" >&2

# Test if server command exists
echo "Testing: ${BUNDLED_RAILS:-bundle exec rails} server --help" >&2
${BUNDLED_RAILS:-bundle exec rails} server --help >&2 | head -3 || echo "Server command test failed" >&2

# Start Rails server using explicit executable or bundle exec
if [ -n "$BUNDLED_RAILS" ] && [ -f "$BUNDLED_RAILS" ]; then
  echo "Executing: exec $BUNDLED_RAILS server -b 0.0.0.0 -p 2358" >&2
  exec "$BUNDLED_RAILS" server -b 0.0.0.0 -p 2358
else
  echo "Executing: exec bundle exec rails server -b 0.0.0.0 -p 2358" >&2
  exec bundle exec rails server -b 0.0.0.0 -p 2358
fi
