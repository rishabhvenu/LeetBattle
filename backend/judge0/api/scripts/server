#!/bin/bash
set -e

# Load config (languages.json, DB config variables, etc)
source ./scripts/load-config

# Ensure no leftover PID files
rm -f tmp/pids/server.pid

# Rails database setup (safe on repeat)
bundle exec rails db:create    || true
bundle exec rails db:migrate   || true
bundle exec rails db:seed      || true

# Start Judge0 API server on correct port
# Use exec to replace shell process with Rails server
# Ensure we're in the right directory and bundle is available
cd /api || exit 1
exec bundle exec rails server -b 0.0.0.0 -p 2358 2>&1
