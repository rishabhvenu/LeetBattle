apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: codeclashers

# Base resources
resources:
  - ../../base
  
  # Production-specific resources (MongoDB and Redis clusters)
  - ../../mongodb
  - ../../statefulsets/redis-cluster.yaml
  - ../../services/redis-cluster-headless.yaml
  - ../../services/redis-cluster-service.yaml
  - ../../configmaps/redis-cluster-config.yaml
  - ../../jobs/redis-cluster-init.yaml

# Production image tags (ArgoCD Image Updater will manage these)
images:
  - name: ghcr.io/rishabhvenu/codeclashers-colyseus
    newTag: latest
  - name: ghcr.io/rishabhvenu/codeclashers-bots
    newTag: latest
  - name: ghcr.io/rishabhvenu/codeclashers-judge0-api-arm64
    newTag: latest
  - name: ghcr.io/rishabhvenu/codeclashers-judge0-worker-arm64
    newTag: latest

# ConfigMap overrides for prod (using patch to merge with base ConfigMap)
patches:
  - target:
      kind: ConfigMap
      name: app-config
    patch: |-
      - op: replace
        path: /data/NODE_ENV
        value: "production"
      - op: replace
        path: /data/REDIS_HOST
        value: "redis-cluster"
      - op: replace
        path: /data/MONGODB_HOST
        value: "mongodb-mongos"
      - op: replace
        path: /data/BOTS_ENABLED
        value: "true"

# Use labels instead of commonLabels to avoid modifying immutable selectors
labels:
  - pairs:
      environment: production
    includeSelectors: false
    includeTemplates: true

