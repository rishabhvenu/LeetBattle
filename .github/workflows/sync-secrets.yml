name: Sync Secrets to Kubernetes

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-secrets:
    runs-on: self-hosted  # Runs on your Oracle VM runner
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure namespace exists
        env:
          KUBECONFIG: /home/ubuntu/.kube/config
        run: |
          k3s kubectl create namespace codeclashers --dry-run=client -o yaml | k3s kubectl apply -f -

      - name: Sync secrets to Kubernetes
        env:
          KUBECONFIG: /home/ubuntu/.kube/config
          # GitHub Secrets
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_USERNAME: ${{ secrets.MONGODB_USERNAME }}
          MONGODB_PASSWORD: ${{ secrets.MONGODB_PASSWORD }}
          JUDGE0_POSTGRES_USER: ${{ secrets.JUDGE0_POSTGRES_USER }}
          JUDGE0_POSTGRES_PASSWORD: ${{ secrets.JUDGE0_POSTGRES_PASSWORD }}
          JUDGE0_POSTGRES_DB: ${{ secrets.JUDGE0_POSTGRES_DB }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INTERNAL_SERVICE_SECRET: ${{ secrets.INTERNAL_SERVICE_SECRET }}
          BOT_SERVICE_SECRET: ${{ secrets.BOT_SERVICE_SECRET }}
          COLYSEUS_RESERVATION_SECRET: ${{ secrets.COLYSEUS_RESERVATION_SECRET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
          # GitHub Variables
          REDIS_HOST: ${{ vars.REDIS_HOST || 'redis-cluster' }}
          REDIS_PORT: ${{ vars.REDIS_PORT || '6379' }}
          JUDGE0_PORT: ${{ vars.JUDGE0_PORT || '2358' }}
          MONGODB_PORT: ${{ vars.MONGODB_PORT || '27017' }}
          COLYSEUS_PORT: ${{ vars.COLYSEUS_PORT || '2567' }}
          S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
          AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
          GRAFANA_ADMIN_USER: ${{ vars.GRAFANA_ADMIN_USER || 'admin' }}
          REPLICA_SET_NAME: ${{ vars.REPLICA_SET_NAME || 'rs0' }}
        run: |
          set -e
          
          # Extract MongoDB username and password from MONGODB_URI if not provided separately
          if [ -z "$MONGODB_USERNAME" ] && [ -n "$MONGODB_URI" ]; then
            MONGO_USER=$(echo "$MONGODB_URI" | sed -n 's|mongodb://\([^:]*\):\([^@]*\)@.*|\1|p' || echo "")
            MONGO_PASS=$(echo "$MONGODB_URI" | sed -n 's|mongodb://\([^:]*\):\([^@]*\)@.*|\2|p' || echo "")
            if [ -n "$MONGO_USER" ]; then
              export MONGODB_USERNAME="$MONGO_USER"
            fi
            if [ -n "$MONGO_PASS" ]; then
              export MONGODB_PASSWORD="$MONGO_PASS"
            fi
          fi
          
          # Default MongoDB username if still not set
          if [ -z "$MONGODB_USERNAME" ]; then
            export MONGODB_USERNAME="${{ secrets.MONGO_INITDB_ROOT_USERNAME || 'admin' }}"
          fi
          
          # Generate MongoDB keyfile if not provided
          if [ -z "$MONGODB_KEYFILE" ]; then
            export MONGODB_KEYFILE=$(openssl rand -base64 756)
          fi
          
          # Build MONGODB_URI_INTERNAL from components
          export MONGODB_URI_INTERNAL="mongodb://${MONGODB_USERNAME}:${MONGODB_PASSWORD}@mongodb.codeclashers.svc.cluster.local:${MONGODB_PORT}/codeclashers?replicaSet=${REPLICA_SET_NAME}&authSource=admin"
          
          # Ensure envsubst is installed
          if ! command -v envsubst &> /dev/null; then
            echo "Installing gettext package for envsubst..."
            sudo apt-get update && sudo apt-get install -y gettext-base
          fi
          
          # Apply secrets template with substitution
          echo "Applying secrets from template..."
          envsubst < backend/k8s/secrets/secrets.yaml.template | k3s kubectl apply -f -
          
          # Create GHCR registry secret separately (docker-registry type)
          echo "Creating GHCR registry secret..."
          k3s kubectl create secret docker-registry ghcr-secret \
            --namespace=codeclashers \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password="${{ secrets.GITHUB_TOKEN }}" \
            --dry-run=client -o yaml | k3s kubectl apply -f -
          
          echo "✅ All secrets synced successfully"

      - name: Verify secrets
        env:
          KUBECONFIG: /home/ubuntu/.kube/config
        run: |
          echo "=== Verifying secrets ==="
          k3s kubectl get secrets -n codeclashers
          echo ""
          echo "✅ Secret sync complete"

