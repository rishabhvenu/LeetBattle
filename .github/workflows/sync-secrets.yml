name: Sync Secrets to Kubernetes

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write  # Required for OIDC authentication with AWS

jobs:
  sync-secrets:
    runs-on: self-hosted  # Runs on your Oracle VM runner
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-SyncSecrets
          aws-region: us-east-1

      - name: Fetch secrets from AWS Secrets Manager
        uses: ./.github/actions/fetch-secrets
        with:
          secret-names: codeclashers/backend,codeclashers/ghcr
          aws-region: us-east-1

      - name: Ensure namespace exists
        env:
          KUBECONFIG: /home/ubuntu/.kube/config
        run: |
          k3s kubectl create namespace codeclashers --dry-run=client -o yaml | k3s kubectl apply -f -

      - name: Sync secrets to Kubernetes
        env:
          KUBECONFIG: /home/ubuntu/.kube/config
          NAMESPACE: codeclashers
          # Secrets are now available from AWS Secrets Manager (fetched in previous step)
          # REDIS_PASSWORD, MONGODB_URI, etc. are exported by fetch-secrets action
          GITHUB_ACTOR: ${{ github.repository_owner }}
          # GitHub Variables (non-sensitive configuration)
          REDIS_HOST: ${{ vars.REDIS_HOST || 'redis-cluster' }}
          REDIS_PORT: ${{ vars.REDIS_PORT || '6379' }}
          JUDGE0_PORT: ${{ vars.JUDGE0_PORT || '2358' }}
          MONGODB_PORT: ${{ vars.MONGODB_PORT || '27017' }}
          COLYSEUS_PORT: ${{ vars.COLYSEUS_PORT || '2567' }}
          S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
          AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
          REPLICA_SET_NAME: ${{ vars.REPLICA_SET_NAME || 'rs0' }}
        run: |
          set -e
          
          # Run unified secret sync script
          ./scripts/deploy/sync-secrets.sh
          
          echo "✅ Secrets synced successfully"

      - name: Verify secrets
        env:
          KUBECONFIG: /home/ubuntu/.kube/config
          NAMESPACE: codeclashers
          KUBECTL: k3s kubectl
        run: |
          echo "=== Verifying secrets ==="
          $KUBECTL get secrets -n $NAMESPACE
          echo ""
          echo "✅ Secret sync complete"

