name: Sync Secrets to Kubernetes

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-secrets:
    runs-on: self-hosted  # Runs on your Oracle VM runner
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure namespace exists
        env:
          KUBECONFIG: /home/ubuntu/.kube/config
        run: |
          k3s kubectl create namespace codeclashers --dry-run=client -o yaml | k3s kubectl apply -f -

      - name: Sync secrets to Kubernetes
        env:
          KUBECONFIG: /home/ubuntu/.kube/config
          NAMESPACE: codeclashers
          # GitHub Secrets
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_USERNAME: ${{ secrets.MONGODB_USERNAME }}
          MONGODB_PASSWORD: ${{ secrets.MONGODB_PASSWORD }}
          JUDGE0_POSTGRES_USER: ${{ secrets.JUDGE0_POSTGRES_USER }}
          JUDGE0_POSTGRES_PASSWORD: ${{ secrets.JUDGE0_POSTGRES_PASSWORD }}
          JUDGE0_POSTGRES_DB: ${{ secrets.JUDGE0_POSTGRES_DB }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INTERNAL_SERVICE_SECRET: ${{ secrets.INTERNAL_SERVICE_SECRET }}
          BOT_SERVICE_SECRET: ${{ secrets.BOT_SERVICE_SECRET }}
          COLYSEUS_RESERVATION_SECRET: ${{ secrets.COLYSEUS_RESERVATION_SECRET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          GITHUB_ACTOR: ${{ github.repository_owner }}
          # GitHub Variables
          REDIS_HOST: ${{ vars.REDIS_HOST || 'redis-cluster' }}
          REDIS_PORT: ${{ vars.REDIS_PORT || '6379' }}
          JUDGE0_PORT: ${{ vars.JUDGE0_PORT || '2358' }}
          MONGODB_PORT: ${{ vars.MONGODB_PORT || '27017' }}
          COLYSEUS_PORT: ${{ vars.COLYSEUS_PORT || '2567' }}
          S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
          AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
          REPLICA_SET_NAME: ${{ vars.REPLICA_SET_NAME || 'rs0' }}
        run: |
          set -e
          
          # Run unified secret sync script
          ./scripts/deploy/sync-secrets.sh
          
          echo "✅ Secrets synced successfully"

      - name: Verify secrets
        env:
          KUBECONFIG: /home/ubuntu/.kube/config
          NAMESPACE: codeclashers
          KUBECTL: k3s kubectl
        run: |
          echo "=== Verifying secrets ==="
          $KUBECTL get secrets -n $NAMESPACE
          echo ""
          echo "✅ Secret sync complete"

