name: Deploy Frontend to AWS (CDK)

on:
  push:
    branches: [main]
    paths:
      - 'client/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:

# Ensure only one deployment runs at a time
concurrency:
  group: frontend-deployment
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Build Next.js (standalone mode)
        working-directory: ./client
        env:
          NODE_ENV: production
          # Add required env vars for build (these may be needed during build)
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        run: npm run build

      - name: Install CDK dependencies
        working-directory: ./client/infra
        run: npm install

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.AWS_ACCOUNT_ID }}" ]; then
            echo "‚ùå Error: AWS_ACCOUNT_ID secret is required"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "‚ùå Error: AWS_ACCESS_KEY_ID secret is required"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "‚ùå Error: AWS_SECRET_ACCESS_KEY secret is required"
            exit 1
          fi
          echo "‚úÖ All required secrets are present"
        working-directory: ./client/infra

      - name: Ensure CDK Bootstrap is configured
        working-directory: ./client/infra
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: us-east-1
          BOOTSTRAP_BUCKET: cdk-hnb659fds-assets-${{ secrets.AWS_ACCOUNT_ID }}-us-east-1
          CDK_TOOLKIT_STACK: CDKToolkit
        run: |
          set -e
          
          echo "üîç Checking CDK bootstrap status..."
          echo "   Account: $AWS_ACCOUNT_ID"
          echo "   Region: $AWS_REGION"
          echo "   Expected bucket: $BOOTSTRAP_BUCKET"
          
          # Check if CDKToolkit CloudFormation stack exists
          echo ""
          echo "üìã Step 1: Checking for CDKToolkit CloudFormation stack..."
          if aws cloudformation describe-stacks \
            --stack-name "$CDK_TOOLKIT_STACK" \
            --region "$AWS_REGION" \
            >/dev/null 2>&1; then
            echo "   ‚úÖ CDKToolkit stack exists"
            STACK_EXISTS=true
          else
            echo "   ‚ùå CDKToolkit stack not found"
            STACK_EXISTS=false
          fi
          
          # Check if bootstrap S3 bucket exists (try multiple methods)
          echo ""
          echo "ü™£ Step 2: Checking for bootstrap S3 bucket..."
          BUCKET_EXISTS=false
          
          # Method 1: Try s3 ls (works even without permissions to list objects)
          if aws s3 ls "s3://$BOOTSTRAP_BUCKET/" \
            --region "$AWS_REGION" \
            >/dev/null 2>&1; then
            echo "   ‚úÖ Bootstrap bucket exists (verified via s3 ls): $BOOTSTRAP_BUCKET"
            BUCKET_EXISTS=true
          # Method 2: Try s3api head-bucket
          elif aws s3api head-bucket \
            --bucket "$BOOTSTRAP_BUCKET" \
            --region "$AWS_REGION" \
            >/dev/null 2>&1; then
            echo "   ‚úÖ Bootstrap bucket exists (verified via head-bucket): $BOOTSTRAP_BUCKET"
            BUCKET_EXISTS=true
          # Method 3: Try checking bucket location
          elif aws s3api get-bucket-location \
            --bucket "$BOOTSTRAP_BUCKET" \
            >/dev/null 2>&1; then
            echo "   ‚úÖ Bootstrap bucket exists (verified via get-bucket-location): $BOOTSTRAP_BUCKET"
            BUCKET_EXISTS=true
          else
            echo "   ‚ùå Bootstrap bucket not found: $BOOTSTRAP_BUCKET"
            echo "      Tried: s3 ls, s3api head-bucket, s3api get-bucket-location"
            BUCKET_EXISTS=false
          fi
          
          # Determine if bootstrap is needed
          echo ""
          if [ "$STACK_EXISTS" = true ] && [ "$BUCKET_EXISTS" = true ]; then
            echo "‚úÖ CDK bootstrap is already configured"
            echo "   Both CDKToolkit stack and bootstrap bucket exist"
            echo "   Skipping bootstrap step"
          else
            if [ "$STACK_EXISTS" = false ]; then
              echo "‚ö†Ô∏è  CDKToolkit stack is missing - bootstrap required"
            fi
            if [ "$BUCKET_EXISTS" = false ]; then
              echo "‚ö†Ô∏è  Bootstrap bucket was deleted or inaccessible - bootstrap required"
              # If stack exists but bucket doesn't, we need to force re-bootstrap
              if [ "$STACK_EXISTS" = true ]; then
                echo "   ‚ö†Ô∏è  Stack exists but bucket missing - this indicates a corrupted bootstrap"
                echo "   ‚ö†Ô∏è  We'll try to bootstrap which should fix the missing bucket"
              fi
            fi
            
            echo ""
            echo "üöÄ Running CDK bootstrap..."
            echo "   Command: npx cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION --require-approval never"
            
            # Check CDKToolkit stack status before bootstrap
            echo ""
            echo "üìä Checking CDKToolkit stack status BEFORE bootstrap..."
            if [ "$STACK_EXISTS" = true ]; then
              echo "   Stack exists, checking details..."
              STACK_STATUS=$(aws cloudformation describe-stacks \
                --stack-name "$CDK_TOOLKIT_STACK" \
                --region "$AWS_REGION" \
                --query 'Stacks[0].StackStatus' \
                --output text 2>/dev/null || echo "UNKNOWN")
              echo "   Stack Status: $STACK_STATUS"
              
              # Get all stack outputs
              echo "   Stack Outputs:"
              aws cloudformation describe-stacks \
                --stack-name "$CDK_TOOLKIT_STACK" \
                --region "$AWS_REGION" \
                --query 'Stacks[0].Outputs' \
                --output table 2>/dev/null || echo "   (Could not retrieve outputs)"
              
              # Get stack resources
              echo ""
              echo "   Stack Resources:"
              aws cloudformation describe-stack-resources \
                --stack-name "$CDK_TOOLKIT_STACK" \
                --region "$AWS_REGION" \
                --query 'StackResources[*].[LogicalResourceId,ResourceType,PhysicalResourceId,ResourceStatus]' \
                --output table 2>/dev/null || echo "   (Could not retrieve resources)"
              
              # Check for S3 bucket resource
              echo ""
              echo "   Looking for S3 bucket resource in stack..."
              S3_BUCKET_RESOURCE=$(aws cloudformation describe-stack-resources \
                --stack-name "$CDK_TOOLKIT_STACK" \
                --region "$AWS_REGION" \
                --query 'StackResources[?ResourceType==`AWS::S3::Bucket`].[LogicalResourceId,PhysicalResourceId,ResourceStatus]' \
                --output text 2>/dev/null || echo "")
              
              if [ -n "$S3_BUCKET_RESOURCE" ]; then
                echo "   Found S3 bucket resource:"
                echo "$S3_BUCKET_RESOURCE" | while read -r line; do
                  echo "      $line"
                done
              else
                echo "   ‚ö†Ô∏è  No S3 bucket resource found in stack!"
              fi
            fi
            
            # Check IAM permissions for S3
            echo ""
            echo "üîê Checking IAM permissions for S3 operations..."
            echo "   Testing s3:CreateBucket permission..."
            if aws s3api head-bucket --bucket "test-bucket-$(date +%s)" --region "$AWS_REGION" 2>&1 | grep -q "403\|Forbidden\|AccessDenied"; then
              echo "   ‚ö†Ô∏è  Permission check inconclusive (expected for non-existent bucket)"
            fi
            
            echo ""
            echo "   Testing s3:ListBuckets permission..."
            if aws s3 ls --region "$AWS_REGION" >/dev/null 2>&1; then
              echo "   ‚úÖ Can list S3 buckets"
            else
              echo "   ‚ö†Ô∏è  Cannot list S3 buckets (may not have permission)"
            fi
            
            # Run bootstrap with verbose output
            echo ""
            echo "üîÑ Executing CDK bootstrap (capturing full output)..."
            set +e  # Temporarily disable exit on error to capture output
            BOOTSTRAP_OUTPUT=$(npx cdk bootstrap \
              aws://$AWS_ACCOUNT_ID/$AWS_REGION \
              --require-approval never \
              --verbose 2>&1)
            BOOTSTRAP_EXIT_CODE=$?
            set -e  # Re-enable exit on error
            
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "CDK Bootstrap Output:"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "$BOOTSTRAP_OUTPUT"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "Exit Code: $BOOTSTRAP_EXIT_CODE"
            echo ""
            
            if [ $BOOTSTRAP_EXIT_CODE -ne 0 ]; then
              echo "‚ùå Bootstrap failed with exit code $BOOTSTRAP_EXIT_CODE"
              exit 1
            fi
            
            # Check if bootstrap said "no changes"
            BOOTSTRAP_NO_CHANGES=false
            if echo "$BOOTSTRAP_OUTPUT" | grep -qi "no changes"; then
              BOOTSTRAP_NO_CHANGES=true
              echo "‚ö†Ô∏è  Bootstrap reported 'no changes'"
            fi
            
            # Check CDKToolkit stack status after bootstrap
            echo ""
            echo "üìä Checking CDKToolkit stack status AFTER bootstrap..."
            sleep 2  # Wait a moment for stack updates to propagate
            
            STACK_AFTER_STATUS=$(aws cloudformation describe-stacks \
              --stack-name "$CDK_TOOLKIT_STACK" \
              --region "$AWS_REGION" \
              --query 'Stacks[0].StackStatus' \
              --output text 2>/dev/null || echo "UNKNOWN")
            echo "   Stack Status: $STACK_AFTER_STATUS"
            
            # Get stack outputs after bootstrap
            echo ""
            echo "   Stack Outputs after bootstrap:"
            aws cloudformation describe-stacks \
              --stack-name "$CDK_TOOLKIT_STACK" \
              --region "$AWS_REGION" \
              --query 'Stacks[0].Outputs' \
              --output table 2>/dev/null || echo "   (Could not retrieve outputs)"
            
            # Get the bucket name from stack outputs
            BUCKET_FROM_STACK=$(aws cloudformation describe-stacks \
              --stack-name "$CDK_TOOLKIT_STACK" \
              --region "$AWS_REGION" \
              --query 'Stacks[0].Outputs[?OutputKey==`BucketName`].OutputValue' \
              --output text 2>/dev/null || echo "")
            
            if [ -n "$BUCKET_FROM_STACK" ] && [ "$BUCKET_FROM_STACK" != "None" ]; then
              echo ""
              echo "   ‚úÖ Found bucket name in stack outputs: $BUCKET_FROM_STACK"
              echo "   Expected bucket name: $BOOTSTRAP_BUCKET"
              
              if [ "$BUCKET_FROM_STACK" != "$BOOTSTRAP_BUCKET" ]; then
                echo "   ‚ö†Ô∏è  WARNING: Bucket name mismatch!"
                echo "      Stack says: $BUCKET_FROM_STACK"
                echo "      We expect: $BOOTSTRAP_BUCKET"
              fi
              
              echo ""
              echo "   Checking if bucket from stack exists..."
              if aws s3 ls "s3://$BUCKET_FROM_STACK/" --region "$AWS_REGION" >/dev/null 2>&1; then
                echo "   ‚úÖ Bucket from stack exists and is accessible: $BUCKET_FROM_STACK"
                BUCKET_EXISTS=true
                BOOTSTRAP_BUCKET="$BUCKET_FROM_STACK"  # Update to use actual bucket name
              else
                echo "   ‚ùå Bucket from stack does not exist or is not accessible: $BUCKET_FROM_STACK"
                echo "   Attempting to check bucket location..."
                aws s3api get-bucket-location --bucket "$BUCKET_FROM_STACK" 2>&1 || true
              fi
            else
              echo ""
              echo "   ‚ö†Ô∏è  No bucket name found in stack outputs"
              echo "   Listing all stack outputs:"
              aws cloudformation describe-stacks \
                --stack-name "$CDK_TOOLKIT_STACK" \
                --region "$AWS_REGION" \
                --query 'Stacks[0].Outputs' \
                --output json 2>/dev/null || echo "{}"
            fi
            
            # Check stack resources after bootstrap
            echo ""
            echo "   Stack Resources after bootstrap:"
            aws cloudformation describe-stack-resources \
              --stack-name "$CDK_TOOLKIT_STACK" \
              --region "$AWS_REGION" \
              --query 'StackResources[*].[LogicalResourceId,ResourceType,PhysicalResourceId,ResourceStatus]' \
              --output table 2>/dev/null || echo "   (Could not retrieve resources)"
            
            # Check for recent stack events that might show what happened
            echo ""
            echo "   Recent stack events (last 10):"
            aws cloudformation describe-stack-events \
              --stack-name "$CDK_TOOLKIT_STACK" \
              --region "$AWS_REGION" \
              --max-items 10 \
              --query 'StackEvents[*].[Timestamp,ResourceStatus,ResourceType,LogicalResourceId,ResourceStatusReason]' \
              --output table 2>/dev/null || echo "   (Could not retrieve events)"
            
            # If bootstrap said "no changes" but bucket is missing, provide diagnostic info
            if [ "$BOOTSTRAP_NO_CHANGES" = true ] && [ "$BUCKET_EXISTS" = false ]; then
              echo ""
              echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
              echo "‚ö†Ô∏è  DIAGNOSTIC: Bootstrap reported 'no changes' but bucket is missing"
              echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
              echo "This indicates the CDKToolkit stack thinks everything is up to date,"
              echo "but the expected S3 bucket does not exist."
              echo ""
              echo "Possible causes:"
              echo "1. Bucket was manually deleted but stack wasn't updated"
              echo "2. Stack has incorrect bucket reference"
              echo "3. Permissions issue preventing bucket creation"
              echo "4. Bootstrap version mismatch"
              echo ""
              echo "Recommended actions:"
              echo "1. Check CloudFormation console for CDKToolkit stack"
              echo "2. Verify stack resources and outputs"
              echo "3. Try deleting and recreating CDKToolkit stack:"
              echo "   aws cloudformation delete-stack --stack-name CDKToolkit --region us-east-1"
              echo "   (Then let this workflow re-bootstrap)"
              echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            fi
            
            echo ""
            echo "‚úÖ CDK bootstrap process completed"
            
            # Verify bootstrap after completion
            echo ""
            echo "üîç Verifying bootstrap configuration..."
            if aws cloudformation describe-stacks \
              --stack-name "$CDK_TOOLKIT_STACK" \
              --region "$AWS_REGION" \
              >/dev/null 2>&1; then
              echo "   ‚úÖ CDKToolkit stack verified"
            else
              echo "   ‚ùå ERROR: CDKToolkit stack verification failed"
              exit 1
            fi
            
            # Re-check bucket with all methods
            VERIFIED=false
            if aws s3 ls "s3://$BOOTSTRAP_BUCKET/" --region "$AWS_REGION" >/dev/null 2>&1; then
              echo "   ‚úÖ Bootstrap bucket verified (s3 ls): $BOOTSTRAP_BUCKET"
              VERIFIED=true
            elif aws s3api head-bucket --bucket "$BOOTSTRAP_BUCKET" --region "$AWS_REGION" >/dev/null 2>&1; then
              echo "   ‚úÖ Bootstrap bucket verified (head-bucket): $BOOTSTRAP_BUCKET"
              VERIFIED=true
            else
              echo "   ‚ùå ERROR: Bootstrap bucket verification failed"
              echo "      Bucket: $BOOTSTRAP_BUCKET"
              echo "      This will cause deployment to fail"
              echo "      Manual intervention may be required"
              exit 1
            fi
          fi
          
          echo ""
          echo "‚úÖ CDK bootstrap check complete"

      - name: Deploy infrastructure with CDK
        working-directory: ./client/infra
        env:
          CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
          CDK_DEFAULT_REGION: us-east-1
          S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
          ROUTE53_HOSTED_ZONE_ID: ${{ secrets.ROUTE53_HOSTED_ZONE_ID }}
          COLYSEUS_DOMAIN: ${{ vars.COLYSEUS_DOMAIN }}
          COLYSEUS_HOST_IP: ${{ vars.COLYSEUS_HOST_IP }}
        run: npx cdk deploy --all --require-approval never --context account=${{ secrets.AWS_ACCOUNT_ID }} --context region=us-east-1

      - name: Output deployment URLs
        run: |
          echo "‚úÖ Infrastructure deployed successfully!"
          echo "Check AWS Console for deployed resources"
