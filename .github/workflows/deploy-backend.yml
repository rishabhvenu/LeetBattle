name: Deploy Backend to Oracle Cloud (Kubernetes)

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:
    inputs:
      build_colyseus:
        description: 'Build Colyseus image'
        required: false
        type: boolean
        default: false
      build_bots:
        description: 'Build Bots image'
        required: false
        type: boolean
        default: false
      build_judge0_api:
        description: 'Build Judge0 API image'
        required: false
        type: boolean
        default: false
      build_judge0_worker:
        description: 'Build Judge0 Worker image'
        required: false
        type: boolean
        default: false

# Ensure only one deployment runs at a time
concurrency:
  group: backend-deployment
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

jobs:
  changed-files:
    runs-on: ubuntu-latest
    outputs:
      colyseus: ${{ steps.filter.outputs.colyseus }}
      bots: ${{ steps.filter.outputs.bots }}
      judge0_api: ${{ steps.filter.outputs.judge0_api }}
      judge0_worker: ${{ steps.filter.outputs.judge0_worker }}
      judge0: ${{ steps.filter.outputs.judge0 }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need at least 2 commits to compare

      - name: Check for changed files
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            colyseus:
              - 'backend/colyseus/**'
            bots:
              - 'backend/bots/**'
            judge0_api:
              - 'backend/judge0/api/**'
            judge0_worker:
              - 'backend/judge0/worker/**'
            judge0:
              - 'backend/judge0/**'

  deploy:
    runs-on: self-hosted  # Runs on your Oracle VM runner
    needs: changed-files
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure namespace exists
        env:
          KUBECONFIG: /home/ubuntu/.kube/config
        run: |
          sudo k3s kubectl create namespace codeclashers --dry-run=client -o yaml | sudo k3s kubectl apply -f -

      - name: Generate image tag
        id: meta
        run: |
          export IMAGE_TAG=$(git rev-parse --short HEAD)
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "Image tag: $IMAGE_TAG"

      - name: Build and push Colyseus image
        id: build-colyseus
        if: |
          needs.changed-files.outputs.colyseus == 'true' ||
          github.event_name == 'workflow_dispatch' && github.event.inputs.build_colyseus == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend/colyseus
          push: true
          tags: |
            ghcr.io/rishabhvenu/codeclashers-colyseus:${{ env.IMAGE_TAG }}
            ghcr.io/rishabhvenu/codeclashers-colyseus:latest
          cache-from: type=gha
          cache-to: type=gha

      - name: Build and push Bots image
        id: build-bots
        if: |
          needs.changed-files.outputs.bots == 'true' ||
          github.event_name == 'workflow_dispatch' && github.event.inputs.build_bots == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend/bots
          push: true
          tags: |
            ghcr.io/rishabhvenu/codeclashers-bots:${{ env.IMAGE_TAG }}
            ghcr.io/rishabhvenu/codeclashers-bots:latest
          cache-from: type=gha
          cache-to: type=gha

      - name: Build and push Judge0 API image
        id: build-judge0-api
        if: |
          needs.changed-files.outputs.judge0_api == 'true' ||
          needs.changed-files.outputs.judge0 == 'true' ||
          github.event_name == 'workflow_dispatch' && github.event.inputs.build_judge0_api == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend/judge0/api
          push: true
          platforms: linux/arm64
          tags: |
            ghcr.io/rishabhvenu/codeclashers-judge0-api-arm64:${{ env.IMAGE_TAG }}
            ghcr.io/rishabhvenu/codeclashers-judge0-api-arm64:latest
          cache-from: type=gha
          cache-to: type=gha

      - name: Build and push Judge0 Worker image
        id: build-judge0-worker
        if: |
          needs.changed-files.outputs.judge0_worker == 'true' ||
          needs.changed-files.outputs.judge0 == 'true' ||
          github.event_name == 'workflow_dispatch' && github.event.inputs.build_judge0_worker == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend/judge0/worker
          push: true
          platforms: linux/arm64
          tags: |
            ghcr.io/rishabhvenu/codeclashers-judge0-worker-arm64:${{ env.IMAGE_TAG }}
            ghcr.io/rishabhvenu/codeclashers-judge0-worker-arm64:latest
          cache-from: type=gha
          cache-to: type=gha

      - name: Set image tags for deployment
        id: image-tags
        run: |
          # Use IMAGE_TAG if build ran, otherwise use 'latest'
          if [ "${{ steps.build-colyseus.outcome }}" != "skipped" ]; then
            echo "COLYSEUS_IMAGE=ghcr.io/rishabhvenu/codeclashers-colyseus:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
          else
            echo "COLYSEUS_IMAGE=ghcr.io/rishabhvenu/codeclashers-colyseus:latest" >> $GITHUB_ENV
          fi
          
          if [ "${{ steps.build-bots.outcome }}" != "skipped" ]; then
            echo "BOTS_IMAGE=ghcr.io/rishabhvenu/codeclashers-bots:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
          else
            echo "BOTS_IMAGE=ghcr.io/rishabhvenu/codeclashers-bots:latest" >> $GITHUB_ENV
          fi
          
          if [ "${{ steps.build-judge0-api.outcome }}" != "skipped" ]; then
            echo "JUDGE0_IMAGE=ghcr.io/rishabhvenu/codeclashers-judge0-api-arm64:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
          else
            echo "JUDGE0_IMAGE=ghcr.io/rishabhvenu/codeclashers-judge0-api-arm64:latest" >> $GITHUB_ENV
          fi
          
          if [ "${{ steps.build-judge0-worker.outcome }}" != "skipped" ]; then
            echo "JUDGE0_WORKER_IMAGE=ghcr.io/rishabhvenu/codeclashers-judge0-worker-arm64:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
          else
            echo "JUDGE0_WORKER_IMAGE=ghcr.io/rishabhvenu/codeclashers-judge0-worker-arm64:latest" >> $GITHUB_ENV
          fi

      - name: Deploy to Kubernetes
        env:
          # Image configuration
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          IMAGE_REGISTRY: ghcr.io/rishabhvenu
          COLYSEUS_IMAGE: ${{ env.COLYSEUS_IMAGE }}
          BOTS_IMAGE: ${{ env.BOTS_IMAGE }}
          JUDGE0_IMAGE: ${{ env.JUDGE0_IMAGE }}
          JUDGE0_WORKER_IMAGE: ${{ env.JUDGE0_WORKER_IMAGE }}
          
          # Kubernetes configuration
          KUBECONFIG: /home/ubuntu/.kube/config
          NAMESPACE: codeclashers
          KUSTOMIZE_OVERLAY: overlays/prod
          
          # Secrets (for deployment)
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_USERNAME: ${{ secrets.MONGODB_USERNAME }}
          MONGODB_PASSWORD: ${{ secrets.MONGODB_PASSWORD }}
          INTERNAL_SERVICE_SECRET: ${{ secrets.INTERNAL_SERVICE_SECRET }}
          BOT_SERVICE_SECRET: ${{ secrets.BOT_SERVICE_SECRET }}
          COLYSEUS_RESERVATION_SECRET: ${{ secrets.COLYSEUS_RESERVATION_SECRET }}
          JUDGE0_POSTGRES_USER: ${{ secrets.JUDGE0_POSTGRES_USER }}
          JUDGE0_POSTGRES_PASSWORD: ${{ secrets.JUDGE0_POSTGRES_PASSWORD }}
          JUDGE0_POSTGRES_DB: ${{ secrets.JUDGE0_POSTGRES_DB }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          
          # Variables
          ORACLE_VM_IP: ${{ vars.COLYSEUS_HOST_IP }}
          REDIS_HOST: ${{ vars.REDIS_HOST || 'redis-cluster' }}
          REDIS_PORT: ${{ vars.REDIS_PORT || '6379' }}
          S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
          AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
        run: |
          set -e
          
          echo "ðŸš€ Deploying using unified scripts"
          
          # Run unified deployment script
          ./scripts/deploy/apply-manifests.sh
          
          echo "âœ… Deployment complete"
      
      - name: Health Check
        env:
          KUBECONFIG: /home/ubuntu/.kube/config
          NAMESPACE: codeclashers
        run: |
          ./scripts/deploy/health-check.sh
