name: Build and Push Backend Images

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:
    inputs:
      build_colyseus:
        description: 'Build Colyseus image'
        required: false
        type: boolean
        default: false
      build_bots:
        description: 'Build Bots image'
        required: false
        type: boolean
        default: false
      build_judge0_api:
        description: 'Build Judge0 API image'
        required: false
        type: boolean
        default: false
      build_judge0_worker:
        description: 'Build Judge0 Worker image'
        required: false
        type: boolean
        default: false

# Ensure only one build runs at a time
concurrency:
  group: backend-images
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

jobs:
  changed-files:
    runs-on: ubuntu-latest
    outputs:
      colyseus: ${{ steps.filter.outputs.colyseus }}
      bots: ${{ steps.filter.outputs.bots }}
      judge0_api: ${{ steps.filter.outputs.judge0_api }}
      judge0_worker: ${{ steps.filter.outputs.judge0_worker }}
      judge0: ${{ steps.filter.outputs.judge0 }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need at least 2 commits to compare

      - name: Check for changed files
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            colyseus:
              - 'backend/colyseus/**'
            bots:
              - 'backend/bots/**'
            judge0_api:
              - 'backend/judge0/api/**'
            judge0_worker:
              - 'backend/judge0/worker/**'
            judge0:
              - 'backend/judge0/**'

  build:
    runs-on: self-hosted  # Runs on your Oracle VM runner
    needs: changed-files
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate image tag
        id: meta
        run: |
          export IMAGE_TAG=$(git rev-parse --short HEAD)
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "Image tag: $IMAGE_TAG"

      - name: Build and push Colyseus image
        id: build-colyseus
        if: |
          needs.changed-files.outputs.colyseus == 'true' ||
          github.event_name == 'workflow_dispatch' && github.event.inputs.build_colyseus == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend/colyseus
          push: true
          tags: |
            ghcr.io/rishabhvenu/codeclashers-colyseus:${{ env.IMAGE_TAG }}
            ghcr.io/rishabhvenu/codeclashers-colyseus:latest
          cache-from: type=gha
          cache-to: type=gha

      - name: Build and push Bots image
        id: build-bots
        if: |
          needs.changed-files.outputs.bots == 'true' ||
          github.event_name == 'workflow_dispatch' && github.event.inputs.build_bots == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend/bots
          push: true
          tags: |
            ghcr.io/rishabhvenu/codeclashers-bots:${{ env.IMAGE_TAG }}
            ghcr.io/rishabhvenu/codeclashers-bots:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Judge0 API image
        id: build-judge0-api
        if: |
          needs.changed-files.outputs.judge0_api == 'true' ||
          needs.changed-files.outputs.judge0 == 'true' ||
          github.event_name == 'workflow_dispatch' && github.event.inputs.build_judge0_api == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend/judge0/api
          push: true
          platforms: linux/arm64
          tags: |
            ghcr.io/rishabhvenu/codeclashers-judge0-api-arm64:${{ env.IMAGE_TAG }}
            ghcr.io/rishabhvenu/codeclashers-judge0-api-arm64:latest
          cache-from: type=gha
          cache-to: type=gha

      - name: Build and push Judge0 Worker image
        id: build-judge0-worker
        if: |
          needs.changed-files.outputs.judge0_worker == 'true' ||
          needs.changed-files.outputs.judge0 == 'true' ||
          github.event_name == 'workflow_dispatch' && github.event.inputs.build_judge0_worker == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend/judge0
          file: ./backend/judge0/worker/Dockerfile
          push: true
          platforms: linux/arm64
          tags: |
            ghcr.io/rishabhvenu/codeclashers-judge0-worker-arm64:${{ env.IMAGE_TAG }}
            ghcr.io/rishabhvenu/codeclashers-judge0-worker-arm64:latest
          cache-from: type=gha
          cache-to: type=gha

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images Built:" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build-colyseus.outcome }}" != "skipped" ]; then
            echo "- ✅ Colyseus: \`ghcr.io/rishabhvenu/codeclashers-colyseus:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.build-bots.outcome }}" != "skipped" ]; then
            echo "- ✅ Bots: \`ghcr.io/rishabhvenu/codeclashers-bots:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.build-judge0-api.outcome }}" != "skipped" ]; then
            echo "- ✅ Judge0 API: \`ghcr.io/rishabhvenu/codeclashers-judge0-api-arm64:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.build-judge0-worker.outcome }}" != "skipped" ]; then
            echo "- ✅ Judge0 Worker: \`ghcr.io/rishabhvenu/codeclashers-judge0-worker-arm64:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** ArgoCD Image Updater will automatically detect and deploy these images to the cluster." >> $GITHUB_STEP_SUMMARY

      
