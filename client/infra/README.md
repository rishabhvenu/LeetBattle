# CodeClashers CDK Infrastructure

This CDK stack deploys the Next.js application as a fully serverless application on AWS using OpenNext.

## Architecture

- **Lambda Function**: Handles SSR (Server-Side Rendering) and API routes (generated by OpenNext)
- **Image Optimization Lambda**: Handles Next.js image optimization (optional, generated by OpenNext)
- **Middleware Lambda@Edge**: Handles Next.js middleware at CloudFront edge (optional, generated by OpenNext)
- **S3 Buckets**: 
  - Static assets (`_next/static/*`, images, fonts)
  - Incremental cache (ISR cache)
  - User avatars (public read access)
- **CloudFront**: CDN that routes requests:
  - `/_next/static/*` → S3 (cached)
  - `/_next/image` → Image Optimization Lambda (cached)
  - `/_next/data/*` → Server Lambda (no cache)
  - `/api/*` → Server Lambda (no cache)
  - `/*` → Server Lambda SSR (no cache)

## Deployment Steps

### Prerequisites

**IMPORTANT: Before deploying, you MUST run OpenNext build:**

```bash
cd ../  # Go to client directory
npm run build:opennext  # This runs 'next build && open-next build'
```

This generates:
- `.open-next/server-function/` - Main server Lambda
- `.open-next/image-optimization-function/` - Image optimization Lambda (if images are used)
- `.open-next/middleware-function/` - Edge middleware (if middleware exists)
- `.open-next/assets/` - Static assets

### Required Environment Variables

Set these in your GitHub Actions secrets or locally:
- `MONGODB_URI`
- `NEXTAUTH_SECRET`
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`
- `S3_BUCKET_NAME` (optional, defaults to auto-generated)
- `ROUTE53_HOSTED_ZONE_ID` (required for automatic certificate creation and domain setup)
- `ROUTE53_HOSTED_ZONE_NAME` (optional, defaults to 'leetbattle.net')
- `NEXTJS_DOMAIN_NAME` (optional, defaults to the hosted zone name)
- `OPENNEXT_CACHE_BUCKET` (optional, defaults to auto-generated)
- `NEXTJS_STATIC_BUCKET_NAME` (optional, defaults to auto-generated)

Note: The certificate is automatically created and validated via DNS in us-east-1 (required by CloudFront).

### Deploy

```bash
npm install
npm run deploy
```

### CI/CD Deployment

The GitHub Actions workflow (`.github/workflows/deploy-frontend.yml`) will:
1. Build Next.js with OpenNext (`npm run build:opennext`)
2. Deploy the CDK stack
3. Upload static assets to S3
4. Create Lambda functions from OpenNext output
5. Configure CloudFront distribution

## How It Works

1. **OpenNext Build**: Running `npx open-next build` analyzes the Next.js build and splits it into:
   - Server functions (SSR/API routes)
   - Image optimization functions
   - Middleware functions (edge runtime)
   - Static assets

2. **CDK Deployment**: The infrastructure stack:
   - Reads `.open-next/` directory structure
   - Optionally parses `open-next.config.json` for configuration
   - Creates Lambda functions from OpenNext output
   - Deploys middleware as Lambda@Edge if present
   - Uploads static assets to S3 with cache headers
   - Configures CloudFront with proper cache behaviors

3. **Static Assets**: OpenNext assets are uploaded to S3 using `BucketDeployment` with:
   - 30-day cache headers
   - Automatic CloudFront cache invalidation
   - Pruning of deleted files

4. **Routing**: CloudFront behaviors route different paths:
   - Static assets → S3 (aggressively cached)
   - Image optimization → Lambda (cached)
   - API routes and SSR → Server Lambda (no cache)

## Environment Variables

All environment variables are passed to the Lambda functions. Make sure to set them in your deployment environment (GitHub Secrets for CI/CD, or `.env` for local deployment).

## Configuration

OpenNext configuration is in `open-next.config.ts` in the client directory. The CDK stack reads the build output from `.open-next/` and optionally parses `open-next.config.json` for runtime settings.

## Outputs

After deployment, CDK outputs:
- `NextJsDistributionUrl`: CloudFront URL for your app
- `NextJsDistributionId`: CloudFront distribution ID
- `NextJsLambdaFunctionArn`: Server Lambda function ARN
- `NextJsStaticBucketName`: S3 bucket for static assets
- `NextJsCertificateArn`: ACM certificate ARN (if domain is configured)
- `NextJsDomainNames`: Configured domain names (if domain is configured)
- `NextJsEdgeFunctionArn`: Middleware Lambda@Edge ARN (if middleware exists)
- `AvatarBucketName`: S3 bucket for user avatars

## Notes

- The server Lambda function timeout is set to 60 seconds with 2048 MB memory
- Image optimization Lambda uses 1024 MB memory with 10 second timeout
- Static assets are cached aggressively by CloudFront (30 days)
- SSR and API routes are never cached
- All S3 buckets use `BLOCK_ALL` public access with bucket policies for controlled access
- CloudFront does NOT use `defaultRootObject` to preserve SSR routing
