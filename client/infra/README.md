# CodeClashers CDK Infrastructure

This CDK stack deploys the Next.js application as a fully serverless application on AWS using OpenNext.

## Architecture

- **Lambda Function**: Handles SSR (Server-Side Rendering) and API routes (generated by OpenNext)
- **Image Optimization Lambda**: Handles Next.js image optimization (optional, generated by OpenNext)
- **Middleware Lambda@Edge**: Handles Next.js middleware at CloudFront edge (optional, generated by OpenNext)
- **S3 Buckets**: 
  - Static assets (`_next/static/*`, images, fonts)
  - Incremental cache (ISR cache)
  - User avatars (public read access)
- **CloudFront**: CDN that routes requests:
  - `/_next/static/*` → S3 (cached)
  - `/_next/image` → Image Optimization Lambda (cached)
  - `/_next/data/*` → Server Lambda (no cache)
  - `/api/*` → Server Lambda (no cache)
  - `/*` → Server Lambda SSR (no cache)

## Deployment Steps

### Prerequisites

**IMPORTANT: Before deploying, you MUST run OpenNext build:**

```bash
cd ../  # Go to client directory
npm run build:opennext  # This runs 'next build && open-next build'
```

This generates:
- `.open-next/server-function/` - Main server Lambda
- `.open-next/image-optimization-function/` - Image optimization Lambda (if images are used)
- `.open-next/middleware-function/` - Edge middleware (if middleware exists)
- `.open-next/assets/` - Static assets

### Required Environment Variables

Set these in your GitHub Actions secrets or locally:

**Backend Connection:**
- `MONGODB_URI` - Full MongoDB connection string with credentials (e.g., `mongodb://user:pass@host:27017/db?authSource=admin`)
- `REDIS_HOST` - Redis hostname (external IP or domain)
- `REDIS_PORT` - Redis port (default: 6379)
- `REDIS_PASSWORD` - Redis password
- `REDIS_CLUSTER_ENABLED` - Set to `true` if using Redis cluster (default: `true`)
- `REDIS_CLUSTER_NODES` - Optional: Comma-separated cluster nodes (e.g., `node1:6379,node2:6379`)
- `NEXT_PUBLIC_COLYSEUS_HTTP_URL` - Colyseus HTTP endpoint (e.g., `http://<external-ip>:2567` or `https://api.yourdomain.com`)
- `NEXT_PUBLIC_COLYSEUS_WS_URL` - Colyseus WebSocket endpoint (e.g., `ws://<external-ip>:2567` or `wss://api.yourdomain.com`)
- `NEXT_PUBLIC_API_BASE` - Optional: API base URL (fallback for REST endpoints)
- `INTERNAL_SERVICE_SECRET` - **REQUIRED** - Secret for authenticating with protected backend endpoints (must match backend secret)

**Next.js Authentication:**
- `NEXTAUTH_SECRET` - NextAuth.js secret (generate with `openssl rand -base64 32`)
- `NEXTAUTH_URL` - Frontend URL (e.g., `https://leetbattle.net`)

**AWS S3 Configuration:**
- `S3_BUCKET_NAME` - Optional: Existing S3 bucket name for avatars (defaults to auto-generated)
- `AWS_REGION` - AWS region (default: `us-east-1`)
- `S3_ENDPOINT` - **DO NOT SET for AWS S3** - SDK automatically determines endpoint from region
  - Only set for MinIO or S3-compatible services (e.g., `http://localhost:9000` for MinIO)
  - For AWS S3, leave unset/empty - the SDK will use `s3.<region>.amazonaws.com` automatically
- **Note**: AWS credentials (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`) are **NOT needed** in Lambda - IAM role credentials are used automatically

**DNS & Domain (Optional but recommended):**
- `ROUTE53_HOSTED_ZONE_ID` - Required for automatic certificate creation and domain setup
- `ROUTE53_HOSTED_ZONE_NAME` - Optional, defaults to 'leetbattle.net'
- `NEXTJS_DOMAIN_NAME` - Optional, defaults to the hosted zone name
- `COLYSEUS_DOMAIN` - Optional: Subdomain for Colyseus (e.g., `api`)
- `COLYSEUS_HOST_IP` - Optional: External IP for Colyseus A record

**OpenNext Cache (Optional):**
- `OPENNEXT_CACHE_BUCKET` - Optional, defaults to auto-generated
- `NEXTJS_STATIC_BUCKET_NAME` - Optional, defaults to auto-generated

Note: The certificate is automatically created and validated via DNS in us-east-1 (required by CloudFront).

### Deploy

```bash
npm install
npm run deploy
```

### CI/CD Deployment

The GitHub Actions workflow (`.github/workflows/deploy-frontend.yml`) will:
1. Build Next.js with OpenNext (`npm run build:opennext`)
2. Deploy the CDK stack
3. Upload static assets to S3
4. Create Lambda functions from OpenNext output
5. Configure CloudFront distribution

## How It Works

1. **OpenNext Build**: Running `npx open-next build` analyzes the Next.js build and splits it into:
   - Server functions (SSR/API routes)
   - Image optimization functions
   - Middleware functions (edge runtime)
   - Static assets

2. **CDK Deployment**: The infrastructure stack:
   - Reads `.open-next/` directory structure
   - Optionally parses `open-next.config.json` for configuration
   - Creates Lambda functions from OpenNext output
   - Deploys middleware as Lambda@Edge if present
   - Uploads static assets to S3 with cache headers
   - Configures CloudFront with proper cache behaviors

3. **Static Assets**: OpenNext assets are uploaded to S3 using `BucketDeployment` with:
   - 30-day cache headers
   - Automatic CloudFront cache invalidation
   - Pruning of deleted files

4. **Routing**: CloudFront behaviors route different paths:
   - Static assets → S3 (aggressively cached)
   - Image optimization → Lambda (cached)
   - API routes and SSR → Server Lambda (no cache)

## Environment Variables

All environment variables are passed to the Lambda functions. Make sure to set them in your deployment environment (GitHub Secrets for CI/CD, or `.env` for local deployment).

## Configuration

OpenNext configuration is in `open-next.config.ts` in the client directory. The CDK stack reads the build output from `.open-next/` and optionally parses `open-next.config.json` for runtime settings.

## Outputs

After deployment, CDK outputs:
- `NextJsDistributionUrl`: CloudFront URL for your app
- `NextJsDistributionId`: CloudFront distribution ID
- `NextJsLambdaFunctionArn`: Server Lambda function ARN
- `NextJsStaticBucketName`: S3 bucket for static assets
- `NextJsCertificateArn`: ACM certificate ARN (if domain is configured)
- `NextJsDomainNames`: Configured domain names (if domain is configured)
- `NextJsEdgeFunctionArn`: Middleware Lambda@Edge ARN (if middleware exists)
- `AvatarBucketName`: S3 bucket for user avatars

## Notes

- The server Lambda function timeout is set to 60 seconds with 2048 MB memory
- Image optimization Lambda uses 1024 MB memory with 10 second timeout
- Static assets are cached aggressively by CloudFront (30 days)
- SSR and API routes are never cached
- All S3 buckets use `BLOCK_ALL` public access with bucket policies for controlled access
- CloudFront does NOT use `defaultRootObject` to preserve SSR routing
